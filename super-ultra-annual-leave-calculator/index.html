<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>연차·미사용수당 슈퍼 울트라 계산기 (Pyodide + 나이스 업로드)</title>

  <!-- ====== 공통 스타일 ====== -->
  <link rel="stylesheet" href="/static/style.css" />

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

  <!-- SheetJS: 엑셀 + CSV 파싱 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* 오류 박스 */
    #errorCard {
      display: none;
    }
    #pyErrorText {
      white-space: pre-wrap;
      font-size: 0.9rem;
      padding: 12px;
      background: #111;
      color: #fff;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
    }
    .status {
      font-size: 0.95rem;
      color: #555;
    }
    .status.danger {
      color: #c8352d;
    }
    .simple-table th {
      text-align: left;
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="shell">
      <h1>연차·미사용수당 슈퍼 울트라 계산기</h1>
      <p class="sub">
        Pyodide 기반 · 로컬 완전 정적 페이지 · Excel/CSV 나이스 근무상황 자동 분석 지원
      </p>
    </div>
  </header>

  <main>
    <!-- ================================
         0. 나이스 업로드 분석
         ================================ -->
    <section class="section">
      <h2>0. 나이스 근무상황 업로드 분석</h2>

      <div class="card">
        <div class="grid two">
          <div class="field">
            <label>근무상황 파일 선택 (.xlsx / .xls / .csv)</label>
            <input id="niceFile" type="file" accept=".xlsx,.xls,.csv" />
          </div>
          <div class="field">
            <label>1일 소정근로시간</label>
            <input id="niceHoursPerDay" type="number" value="8" step="0.5" class="numeric" />
          </div>
        </div>

        <p class="muted local-small">
          헤더에서 ‘종별’, ‘일수/기간’ 자동 탐색 후 파이썬으로 총 합계 계산.
        </p>

        <div class="row">
          <button id="btnAnalyze" class="btn primary" disabled>업로드·복무 집계</button>
          <button id="btnResetNice" class="btn ghost">초기화</button>
        </div>

        <div id="niceStatus" class="status">Pyodide 로딩 필요</div>
      </div>

      <div id="niceSummaryWrap" class="table-wrapper" style="display:none; margin-top:14px;">
        <table class="sheetlike simple-table">
          <thead>
            <tr>
              <th>종별</th>
              <th>건수</th>
              <th>합계 (일·시간·분)</th>
              <th>합계 시간(h, 10진법)</th>
              <th>환산(일 + 시간)</th>
            </tr>
          </thead>
          <tbody id="niceSummaryBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ================================
         1. Pyodide 상태
         ================================ -->
    <section class="section">
      <h2>1. 파이썬 엔진 상태</h2>
      <p id="pyStatus" class="status">Pyodide 로딩 중...</p>
    </section>

    <!-- ================================
         2. 연차·수당 계산 입력
         ================================ -->
    <section class="section">
      <h2>2. 연차·수당 계산 입력</h2>

      <div class="card">
        <h3>2-1. 규정 및 근속</h3>
        <div class="grid three">
          <div class="field">
            <label>규정 세트</label>
            <select id="ruleId">
              <option value="law_basic">법정 기본형</option>
              <option value="gw_school_cba">학교근무자 CBA</option>
              <option value="gw_institute_cba">기관근무자 CBA</option>
              <option value="gw_wage_guideline">통상임금 지침형</option>
              <option value="custom">커스텀</option>
            </select>
          </div>

          <div class="field">
            <label>근속연수(년)</label>
            <input id="svcYears" type="number" step="0.1" value="1.0" class="numeric" />
          </div>

          <div class="field">
            <label>완전년수</label>
            <input id="svcFullYears" type="number" step="1" value="1" class="numeric" />
          </div>
        </div>

        <div class="grid three">
          <div class="field">
            <label>출근율(%)</label>
            <input id="attendanceRate" type="number" value="98" step="0.1" class="numeric" />
          </div>
          <div class="field">
            <label>월 개근 개월수</label>
            <input id="fullMonths" type="number" value="12" step="1" class="numeric" />
          </div>
          <div class="field">
            <label>입사일 / 기준일(텍스트)</label>
            <input id="hireDate" type="text" placeholder="2024-03-01" />
            <input id="baseDate" type="text" placeholder="2025-03-01" style="margin-top:4px;" />
          </div>
        </div>
      </div>

      <div class="card">
        <h3>2-2. 임금 정보</h3>

        <div class="grid three">
          <div class="field">
            <label>임금 형태</label>
            <select id="wageType">
              <option value="hourly">시급</option>
              <option value="daily">일급</option>
              <option value="monthly" selected>월급</option>
            </select>
          </div>

          <div class="field">
            <label>금액</label>
            <input id="wageAmount" type="number" value="2300000" class="numeric" />
          </div>

          <div class="field">
            <label>1일 근로시간</label>
            <input id="hoursPerDay" type="number" value="8" step="0.5" class="numeric" />
          </div>
        </div>

        <div class="grid two">
          <div class="field">
            <label>월 소정근로일수</label>
            <input id="monthlyDays" type="number" step="0.1" value="20.5" class="numeric" />
          </div>
        </div>
      </div>

      <div class="card">
        <h3>2-3. 연차 부여/사용</h3>

        <div class="grid two">
          <div class="field">
            <label>부여 연차일수</label>
            <input id="grantedDays" type="number" step="0.5" value="26" class="numeric" />
          </div>
          <div class="field">
            <label>사용 연차일수</label>
            <input id="usedDays" type="number" step="0.5" value="10.5" class="numeric" />
          </div>
        </div>
      </div>

      <button id="btnRun" class="btn primary" disabled>연차·수당 계산</button>
    </section>

    <!-- ================================
         3. 결과 출력
         ================================ -->
    <section class="section">
      <h2>3. 계산 결과</h2>
      <div class="card">
        <div class="result-grid">

          <div class="result-item">
            <div class="result-label">규정 세트</div>
            <div class="result-value" id="resRule">-</div>
          </div>

          <div class="result-item">
            <div class="result-label">추천 연차일수</div>
            <div class="result-value" id="resSuggested">-</div>
          </div>

          <div class="result-item">
            <div class="result-label">추천 설명</div>
            <div class="result-value" id="resDesc" style="text-align:left;">-</div>
          </div>

          <hr />

          <div class="result-item">
            <div class="result-label">부여/사용/미사용</div>
            <div class="result-value" id="resDays">-</div>
          </div>

          <div class="result-item">
            <div class="result-label">1일 통상임금(10원단위)</div>
            <div class="result-value" id="resDaily">-</div>
          </div>

          <div class="result-item">
            <div class="result-label">미사용 연차수당(계산값)</div>
            <div class="result-value" id="resPayout">-</div>
          </div>

          <div class="result-item">
            <div class="result-label">최종(절사 적용)</div>
            <div class="result-value highlight" id="resFinal">-</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ================================
         4. 오류 박스
         ================================ -->
    <section class="section" id="errorCard">
      <h2>4. 파이썬 오류 메시지</h2>
      <div class="card">
        <pre id="pyErrorText">(현재 오류 없음)</pre>
      </div>
    </section>
  </main>

  <script>
    let pyodide = null;
    let pyReady = false;

    function clearPyError() {
      document.getElementById("errorCard").style.display = "none";
      document.getElementById("pyErrorText").textContent = "(현재 오류 없음)";
    }

    function showPyError(err, context) {
      const box = document.getElementById("errorCard");
      const pre = document.getElementById("pyErrorText");
      let msg = "";
      msg += context ? `[컨텍스트] ${context}\n\n` : "";
      msg += String(err);
      pre.textContent = msg;
      box.style.display = "block";
      console.error("PY ERROR:", err);
    }

    // ===== Pyodide 초기화 =====
    async function initPyodide() {
      try {
        document.getElementById("pyStatus").textContent = "Pyodide 로딩 중...";
        pyodide = await loadPyodide();

        // annual_engine.py 파일 읽어서 FS에 저장
        const engine = await (await fetch("annual_engine.py")).text();
        pyodide.FS.writeFile("annual_engine.py", engine);

        // 실제 모듈 import
        await pyodide.runPythonAsync("import annual_engine");

        pyReady = true;
        document.getElementById("pyStatus").textContent =
          "Pyodide + annual_engine 모듈 로딩 완료.";
        document.getElementById("btnAnalyze").disabled = false;
        document.getElementById("btnRun").disabled = false;
      } catch (err) {
        document.getElementById("pyStatus").textContent =
          "Pyodide 로딩 실패 (아래 오류박스 확인)";
        showPyError(err, "Pyodide 초기화 중");
      }
    }
    initPyodide();

    // ===== CSV/엑셀 복무 분석 =====
    function guessLeaveCol(headers) {
      const cands = ["종별", "복무", "근무상태", "근태", "근무구분"];
      for (const h of headers) {
        if (!h) continue;
        if (cands.some(c => h.includes(c))) return h;
      }
      return null;
    }

    function guessDurCol(headers) {
      const cands = ["일수/기간", "일수", "기간"];
      for (const h of headers) {
        if (!h) continue;
        if (cands.some(c => h.includes(c))) return h;
      }
      return null;
    }

    document.getElementById("btnAnalyze").addEventListener("click", () => {
      clearPyError();

      if (!pyReady) return alert("Pyodide 로딩을 기다려주세요.");

      const file = document.getElementById("niceFile").files[0];
      if (!file) return alert("파일 선택 필요");

      const ext = file.name.split(".").pop().toLowerCase();
      const hpd = Number(document.getElementById("niceHoursPerDay").value || 8);

      const reader = new FileReader();
      const status = document.getElementById("niceStatus");
      status.textContent = "파일 읽는 중...";

      reader.onload = async e => {
        try {
          let wb;
          if (ext === "csv") {
            wb = XLSX.read(e.target.result, { type: "string" });
          } else {
            wb = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
          }

          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

          if (!rows.length) {
            status.textContent = "빈 파일입니다.";
            return;
          }

          const headers = Object.keys(rows[0]);
          const leaveCol = guessLeaveCol(headers);
          const durCol = guessDurCol(headers);

          if (!leaveCol || !durCol) {
            status.textContent = "‘종별’ 또는 ‘일수/기간’ 열 없음";
            return alert("헤더 확인 필요");
          }

          // JS records 준비
          const records = rows
            .filter(r => r[leaveCol])
            .map(r => ({
              leave_type: String(r[leaveCol]),
              duration_raw: String(r[durCol] ?? "")
            }));

          // Pyodide로 전달
          pyodide.globals.set("records_js", pyodide.toPy(records));
          pyodide.globals.set("hours_js", hpd);

          const result = await pyodide.runPythonAsync(`
from annual_engine import NiceRecord, summarize_nice_records
py_recs = [NiceRecord(leave_type=r["leave_type"], duration_raw=r["duration_raw"], hours_per_day=hours_js)
           for r in records_js]
summarize_nice_records(py_recs)
          `);

          const data = result.toJs({ deep: true });

          const tbody = document.getElementById("niceSummaryBody");
          tbody.innerHTML = "";

          data.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${row.leave_type}</td>
              <td style="text-align:right">${row.count}</td>
              <td style="text-align:right">${row.sum_d_h_m}</td>
              <td style="text-align:right">${row.sum_hours_decimal.toFixed(1)}</td>
              <td style="text-align:right">${row.converted_days_hours}</td>
            `;
            tbody.appendChild(tr);
          });

          document.getElementById("niceSummaryWrap").style.display = "block";
          status.textContent = "집계 완료.";

        } catch (err) {
          status.textContent = "오류 발생";
          showPyError(err, "summarize_nice_records 실행 중");
        }
      };

      if (ext === "csv") reader.readAsText(file, "utf-8");
      else reader.readAsArrayBuffer(file);
    });

    document.getElementById("btnResetNice").addEventListener("click", () => {
      document.getElementById("niceFile").value = "";
      document.getElementById("niceSummaryBody").innerHTML = "";
      document.getElementById("niceSummaryWrap").style.display = "none";
      document.getElementById("niceStatus").textContent = pyReady
        ? "파일 선택 후 업로드·집계 가능"
        : "Pyodide 로딩 필요";
      clearPyError();
    });

    // ===== full_pipeline 연차 계산 =====
    document.getElementById("btnRun").addEventListener("click", async () => {
      clearPyError();
      if (!pyReady) return alert("Pyodide 준비 안 됨");

      const ruleId = document.getElementById("ruleId").value;

      const svc = {
        hire_date: document.getElementById("hireDate").value,
        base_date: document.getElementById("baseDate").value,
        service_years: Number(document.getElementById("svcYears").value),
        full_years: Number(document.getElementById("svcFullYears").value),
        attendance_rate: Number(document.getElementById("attendanceRate").value),
        full_months: Number(document.getElementById("fullMonths").value),
      };

      const wage = {
        wage_type: document.getElementById("wageType").value,
        wage_amount: Number(document.getElementById("wageAmount").value),
        hours_per_day: Number(document.getElementById("hoursPerDay").value),
        monthly_work_days: Number(document.getElementById("monthlyDays").value),
      };

      const granted = Number(document.getElementById("grantedDays").value);
      const used = Number(document.getElementById("usedDays").value);

      try {
        pyodide.globals.set("svc_js", pyodide.toPy(svc));
        pyodide.globals.set("wage_js", pyodide.toPy(wage));

        const result = await pyodide.runPythonAsync(`
from annual_engine import full_pipeline
full_pipeline("${ruleId}", svc_js, wage_js, ${granted}, ${used})
        `);

        const out = result.toJs({ deep: true });

        // 결과 표시
        document.getElementById("resRule").textContent = out.rule.name;

        const sug = out.suggestion;
        document.getElementById("resSuggested").textContent =
          sug.suggested_days === null ? "직접 입력" : `${sug.suggested_days} 일`;
        document.getElementById("resDesc").textContent = sug.description;

        const p = out.payout;
        const daily = Math.floor((p.daily_wage_raw || 0) / 10) * 10;
        const raw = Math.floor((p.payout_raw || 0) / 10) * 10;
        const final = Math.floor((p.payout_rounded || 0) / 10) * 10;

        document.getElementById("resDays").textContent =
          `부여 ${p.granted_days} / 사용 ${p.used_days} / 미사용 ${p.unused_days}`;

        document.getElementById("resDaily").textContent =
          daily ? daily.toLocaleString("ko-KR") + "원" : "-";

        document.getElementById("resPayout").textContent =
          raw ? raw.toLocaleString("ko-KR") + "원" : "-";

        document.getElementById("resFinal").textContent =
          final ? final.toLocaleString("ko-KR") + "원" : "-";

      } catch (err) {
        showPyError(err, "full_pipeline 실행 중");
      }
    });
  </script>
</body>
</html>
